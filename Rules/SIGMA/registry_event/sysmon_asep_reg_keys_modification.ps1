# Get-WinEvent -LogName Microsoft-Windows-Sysmon/Operational | where {((($_.ID -eq "12" -or $_.ID -eq "13" -or $_.ID -eq "14")) -and ((((((((((((($_.message -match "TargetObject.*.*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows CE Services\\AutoStart" -or $_.message -match "TargetObject.*.*\\Software\\Wow6432Node\\Microsoft\\Command Processor\\Autorun" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Wow6432Node\\Microsoft\\Active Setup\\Installed Components" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnDisconnect" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnConnect" -or $_.message -match "TargetObject.*.*\\SYSTEM\\Setup\\CmdLine" -or $_.message -match "TargetObject.*.*\\Software\\Microsoft\\Ctf\\LangBarAddin" -or $_.message -match "TargetObject.*.*\\Software\\Microsoft\\Command Processor\\Autorun" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Classes\\Protocols\\Handler" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Classes\\Protocols\\Filter" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Classes\\Htmlfile\\Shell\\Open\\Command\\(Default)" -or $_.message -match "TargetObject.*.*\\Environment\\UserInitMprLogonScript" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Policies\\Microsoft\\Windows\\Control Panel\\Desktop\\Scrnsave.exe" -or $_.message -match "TargetObject.*.*\\Software\\Microsoft\\Internet Explorer\\UrlSearchHooks" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Microsoft\\Internet Explorer\\Desktop\\Components" -or $_.message -match "TargetObject.*.*\\Software\\Classes\\Clsid\\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}\\Inprocserver32" -or $_.message -match "TargetObject.*.*\\Control Panel\\Desktop\\Scrnsave.exe") -or ($_.message -match "TargetObject.*.*\\System\\CurrentControlSet\\Control\\Session Manager" -and ($_.message -match "TargetObject.*.*\\SetupExecute" -or $_.message -match "TargetObject.*.*\\S0InitialCommand" -or $_.message -match "TargetObject.*.*\\KnownDlls" -or $_.message -match "TargetObject.*.*\\Execute" -or $_.message -match "TargetObject.*.*\\BootExecute" -or $_.message -match "TargetObject.*.*\\AppCertDlls"))) -or ($_.message -match "TargetObject.*.*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion" -and ($_.message -match "TargetObject.*.*\\ShellServiceObjectDelayLoad" -or $_.message -match "TargetObject.*.*\\Run" -or $_.message -match "TargetObject.*.*\\Policies\\System\\Shell" -or $_.message -match "TargetObject.*.*\\Policies\\Explorer\\Run" -or $_.message -match "TargetObject.*.*\\Group Policy\\Scripts\\Startup" -or $_.message -match "TargetObject.*.*\\Group Policy\\Scripts\\Shutdown" -or $_.message -match "TargetObject.*.*\\Group Policy\\Scripts\\Logon" -or $_.message -match "TargetObject.*.*\\Group Policy\\Scripts\\Logoff" -or $_.message -match "TargetObject.*.*\\Explorer\\ShellServiceObjects" -or $_.message -match "TargetObject.*.*\\Explorer\\ShellIconOverlayIdentifiers" -or $_.message -match "TargetObject.*.*\\Explorer\\ShellExecuteHooks" -or $_.message -match "TargetObject.*.*\\Explorer\\SharedTaskScheduler" -or $_.message -match "TargetObject.*.*\\Explorer\\Browser Helper Objects" -or $_.message -match "TargetObject.*.*\\Authentication\\PLAP Providers" -or $_.message -match "TargetObject.*.*\\Authentication\\Credential Providers" -or $_.message -match "TargetObject.*.*\\Authentication\\Credential Provider Filters"))) -or ($_.message -match "TargetObject.*.*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion" -and ($_.message -match "TargetObject.*.*\\Winlogon\\VmApplet" -or $_.message -match "TargetObject.*.*\\Winlogon\\Userinit" -or $_.message -match "TargetObject.*.*\\Winlogon\\Taskman" -or $_.message -match "TargetObject.*.*\\Winlogon\\Shell" -or $_.message -match "TargetObject.*.*\\Winlogon\\GpExtensions" -or $_.message -match "TargetObject.*.*\\Winlogon\\AppSetup" -or $_.message -match "TargetObject.*.*\\Winlogon\\AlternateShells\\AvailableShells" -or $_.message -match "TargetObject.*.*\\Windows\\IconServiceLib" -or $_.message -match "TargetObject.*.*\\Windows\\Appinit_Dlls" -or $_.message -match "TargetObject.*.*\\Image File Execution Options" -or $_.message -match "TargetObject.*.*\\Font Drivers" -or $_.message -match "TargetObject.*.*\\Drivers32" -or $_.message -match "TargetObject.*.*\\Windows\\Run" -or $_.message -match "TargetObject.*.*\\Windows\\Load"))) -or ($_.message -match "TargetObject.*.*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion" -and ($_.message -match "TargetObject.*.*\\ShellServiceObjectDelayLoad" -or $_.message -match "TargetObject.*.*\\Run" -or $_.message -match "TargetObject.*.*\\Explorer\\ShellServiceObjects" -or $_.message -match "TargetObject.*.*\\Explorer\\ShellIconOverlayIdentifiers" -or $_.message -match "TargetObject.*.*\\Explorer\\ShellExecuteHooks" -or $_.message -match "TargetObject.*.*\\Explorer\\SharedTaskScheduler" -or $_.message -match "TargetObject.*.*\\Explorer\\Browser Helper Objects"))) -or ($_.message -match "TargetObject.*.*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion" -and ($_.message -match "TargetObject.*.*\\Windows\\Appinit_Dlls" -or $_.message -match "TargetObject.*.*\\Image File Execution Options" -or $_.message -match "TargetObject.*.*\\Drivers32"))) -or ((($_.ID -eq "12" -or $_.ID -eq "13" -or $_.ID -eq "14")) -and ($_.message -match "TargetObject.*.*\\Software\\Wow6432Node\\Microsoft\\Office" -or $_.message -match "TargetObject.*.*\\Software\\Microsoft\\Office") -and ($_.message -match "TargetObject.*.*\\Word\\Addins" -or $_.message -match "TargetObject.*.*\\PowerPoint\\Addins" -or $_.message -match "TargetObject.*.*\\Outlook\\Addins" -or $_.message -match "TargetObject.*.*\\Onenote\\Addins" -or $_.message -match "TargetObject.*.*\\Excel\\Addins" -or $_.message -match "TargetObject.*.*\\Access\\Addins" -or $_.message -match "TargetObject.*.*test\\Special\\Perf"))) -or ((($_.ID -eq "12" -or $_.ID -eq "13" -or $_.ID -eq "14")) -and ($_.message -match "TargetObject.*.*\\Software\\Wow6432Node\\Microsoft\\Internet Explorer" -or $_.message -match "TargetObject.*.*\\Software\\Microsoft\\Internet Explorer") -and ($_.message -match "TargetObject.*.*\\Toolbar" -or $_.message -match "TargetObject.*.*\\Extensions" -or $_.message -match "TargetObject.*.*\\Explorer Bars"))) -or ($_.message -match "TargetObject.*.*\\Software\\Wow6432Node\\Classes" -and ($_.message -match "TargetObject.*.*\\Folder\\ShellEx\\ExtShellFolderViews" -or $_.message -match "TargetObject.*.*\\Folder\\ShellEx\\DragDropHandlers" -or $_.message -match "TargetObject.*.*\\Folder\\ShellEx\\ColumnHandlers" -or $_.message -match "TargetObject.*.*\\Directory\\Shellex\\DragDropHandlers" -or $_.message -match "TargetObject.*.*\\Directory\\Shellex\\CopyHookHandlers" -or $_.message -match "TargetObject.*.*\\CLSID\\{AC757296-3522-4E11-9862-C17BE5A1767E}\\Instance" -or $_.message -match "TargetObject.*.*\\CLSID\\{ABE3B9A4-257D-4B97-BD1A-294AF496222E}\\Instance" -or $_.message -match "TargetObject.*.*\\CLSID\\{7ED96837-96F0-4812-B211-F13C24117ED3}\\Instance" -or $_.message -match "TargetObject.*.*\\CLSID\\{083863F1-70DE-11d0-BD40-00A0C911CE86}\\Instance" -or $_.message -match "TargetObject.*.*\\AllFileSystemObjects\\ShellEx\\DragDropHandlers" -or $_.message -match "TargetObject.*.*\\ShellEx\\PropertySheetHandlers" -or $_.message -match "TargetObject.*.*\\ShellEx\\ContextMenuHandlers"))) -or ($_.message -match "TargetObject.*.*\\Software\\Classes" -and ($_.message -match "TargetObject.*.*\\Folder\\ShellEx\\ExtShellFolderViews" -or $_.message -match "TargetObject.*.*\\Folder\\ShellEx\\DragDropHandlers" -or $_.message -match "TargetObject.*.*\\Folder\\Shellex\\ColumnHandlers" -or $_.message -match "TargetObject.*.*\\Filter" -or $_.message -match "TargetObject.*.*\\Exefile\\Shell\\Open\\Command\\(Default)" -or $_.message -match "TargetObject.*.*\\Directory\\Shellex\\DragDropHandlers" -or $_.message -match "TargetObject.*.*\\Directory\\Shellex\\CopyHookHandlers" -or $_.message -match "TargetObject.*.*\\CLSID\\{AC757296-3522-4E11-9862-C17BE5A1767E}\\Instance" -or $_.message -match "TargetObject.*.*\\CLSID\\{ABE3B9A4-257D-4B97-BD1A-294AF496222E}\\Instance" -or $_.message -match "TargetObject.*.*\\CLSID\\{7ED96837-96F0-4812-B211-F13C24117ED3}\\Instance" -or $_.message -match "TargetObject.*.*\\CLSID\\{083863F1-70DE-11d0-BD40-00A0C911CE86}\\Instance" -or $_.message -match "TargetObject.*.*\\Classes\\AllFileSystemObjects\\ShellEx\\DragDropHandlers" -or $_.message -match "TargetObject.*.*\\.exe" -or $_.message -match "TargetObject.*.*\\.cmd" -or $_.message -match "TargetObject.*.*\\ShellEx\\PropertySheetHandlers" -or $_.message -match "TargetObject.*.*\\ShellEx\\ContextMenuHandlers"))) -or ($_.message -match "TargetObject.*.*\\Software\\Policies\\Microsoft\\Windows\\System\\Scripts" -and ($_.message -match "TargetObject.*.*\\Startup" -or $_.message -match "TargetObject.*.*\\Shutdown" -or $_.message -match "TargetObject.*.*\\Logon" -or $_.message -match "TargetObject.*.*\\Logoff"))) -or ($_.message -match "TargetObject.*.*\\System\\CurrentControlSet\\Services\\WinSock2\\Parameters" -and ($_.message -match "TargetObject.*.*\\Protocol_Catalog9\\Catalog_Entries" -or $_.message -match "TargetObject.*.*\\NameSpace_Catalog5\\Catalog_Entries"))) -or ($_.message -match "TargetObject.*.*\\SYSTEM\\CurrentControlSet\\Control" -and ($_.message -match "TargetObject.*.*\\Terminal Server\\WinStations\\RDP-Tcp\\InitialProgram" -or $_.message -match "TargetObject.*.*\\Terminal Server\\Wds\\rdpwd\\StartupPrograms" -or $_.message -match "TargetObject.*.*\\SecurityProviders\\SecurityProviders" -or $_.message -match "TargetObject.*.*\\SafeBoot\\AlternateShell" -or $_.message -match "TargetObject.*.*\\Print\\Providers" -or $_.message -match "TargetObject.*.*\\Print\\Monitors" -or $_.message -match "TargetObject.*.*\\NetworkProvider\\Order" -or $_.message -match "TargetObject.*.*\\Lsa\\Notification Packages" -or $_.message -match "TargetObject.*.*\\Lsa\\Authentication Packages" -or $_.message -match "TargetObject.*.*\\BootVerificationProgram\\ImagePath")))) } | select TimeCreated,Id,RecordId,ProcessId,MachineName,Message

function Add-Rule {

    $ruleName = "sysmon_asep_reg_keys_modification";
    $detectRule = {
        
        function Search-DetectableEvents {
            param (
                $event
            )
            
            $ruleName = "sysmon_asep_reg_keys_modification";
            $detectedMessage = "Detects modification of autostart extensibility point (ASEP) in registry.";
            $result = $event |  where { ((($_.ID -eq "12" -or $_.ID -eq "13" -or $_.ID -eq "14")) -and ((((((((((((($_.message -match "TargetObject.*.*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows CE Services\\AutoStart" -or $_.message -match "TargetObject.*.*\\Software\\Wow6432Node\\Microsoft\\Command Processor\\Autorun" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Wow6432Node\\Microsoft\\Active Setup\\Installed Components" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnDisconnect" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnConnect" -or $_.message -match "TargetObject.*.*\\SYSTEM\\Setup\\CmdLine" -or $_.message -match "TargetObject.*.*\\Software\\Microsoft\\Ctf\\LangBarAddin" -or $_.message -match "TargetObject.*.*\\Software\\Microsoft\\Command Processor\\Autorun" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Classes\\Protocols\\Handler" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Classes\\Protocols\\Filter" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Classes\\Htmlfile\\Shell\\Open\\Command\\(Default)" -or $_.message -match "TargetObject.*.*\\Environment\\UserInitMprLogonScript" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Policies\\Microsoft\\Windows\\Control Panel\\Desktop\\Scrnsave.exe" -or $_.message -match "TargetObject.*.*\\Software\\Microsoft\\Internet Explorer\\UrlSearchHooks" -or $_.message -match "TargetObject.*.*\\SOFTWARE\\Microsoft\\Internet Explorer\\Desktop\\Components" -or $_.message -match "TargetObject.*.*\\Software\\Classes\\Clsid\\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}\\Inprocserver32" -or $_.message -match "TargetObject.*.*\\Control Panel\\Desktop\\Scrnsave.exe") -or ($_.message -match "TargetObject.*.*\\System\\CurrentControlSet\\Control\\Session Manager" -and ($_.message -match "TargetObject.*.*\\SetupExecute" -or $_.message -match "TargetObject.*.*\\S0InitialCommand" -or $_.message -match "TargetObject.*.*\\KnownDlls" -or $_.message -match "TargetObject.*.*\\Execute" -or $_.message -match "TargetObject.*.*\\BootExecute" -or $_.message -match "TargetObject.*.*\\AppCertDlls"))) -or ($_.message -match "TargetObject.*.*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion" -and ($_.message -match "TargetObject.*.*\\ShellServiceObjectDelayLoad" -or $_.message -match "TargetObject.*.*\\Run" -or $_.message -match "TargetObject.*.*\\Policies\\System\\Shell" -or $_.message -match "TargetObject.*.*\\Policies\\Explorer\\Run" -or $_.message -match "TargetObject.*.*\\Group Policy\\Scripts\\Startup" -or $_.message -match "TargetObject.*.*\\Group Policy\\Scripts\\Shutdown" -or $_.message -match "TargetObject.*.*\\Group Policy\\Scripts\\Logon" -or $_.message -match "TargetObject.*.*\\Group Policy\\Scripts\\Logoff" -or $_.message -match "TargetObject.*.*\\Explorer\\ShellServiceObjects" -or $_.message -match "TargetObject.*.*\\Explorer\\ShellIconOverlayIdentifiers" -or $_.message -match "TargetObject.*.*\\Explorer\\ShellExecuteHooks" -or $_.message -match "TargetObject.*.*\\Explorer\\SharedTaskScheduler" -or $_.message -match "TargetObject.*.*\\Explorer\\Browser Helper Objects" -or $_.message -match "TargetObject.*.*\\Authentication\\PLAP Providers" -or $_.message -match "TargetObject.*.*\\Authentication\\Credential Providers" -or $_.message -match "TargetObject.*.*\\Authentication\\Credential Provider Filters"))) -or ($_.message -match "TargetObject.*.*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion" -and ($_.message -match "TargetObject.*.*\\Winlogon\\VmApplet" -or $_.message -match "TargetObject.*.*\\Winlogon\\Userinit" -or $_.message -match "TargetObject.*.*\\Winlogon\\Taskman" -or $_.message -match "TargetObject.*.*\\Winlogon\\Shell" -or $_.message -match "TargetObject.*.*\\Winlogon\\GpExtensions" -or $_.message -match "TargetObject.*.*\\Winlogon\\AppSetup" -or $_.message -match "TargetObject.*.*\\Winlogon\\AlternateShells\\AvailableShells" -or $_.message -match "TargetObject.*.*\\Windows\\IconServiceLib" -or $_.message -match "TargetObject.*.*\\Windows\\Appinit_Dlls" -or $_.message -match "TargetObject.*.*\\Image File Execution Options" -or $_.message -match "TargetObject.*.*\\Font Drivers" -or $_.message -match "TargetObject.*.*\\Drivers32" -or $_.message -match "TargetObject.*.*\\Windows\\Run" -or $_.message -match "TargetObject.*.*\\Windows\\Load"))) -or ($_.message -match "TargetObject.*.*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion" -and ($_.message -match "TargetObject.*.*\\ShellServiceObjectDelayLoad" -or $_.message -match "TargetObject.*.*\\Run" -or $_.message -match "TargetObject.*.*\\Explorer\\ShellServiceObjects" -or $_.message -match "TargetObject.*.*\\Explorer\\ShellIconOverlayIdentifiers" -or $_.message -match "TargetObject.*.*\\Explorer\\ShellExecuteHooks" -or $_.message -match "TargetObject.*.*\\Explorer\\SharedTaskScheduler" -or $_.message -match "TargetObject.*.*\\Explorer\\Browser Helper Objects"))) -or ($_.message -match "TargetObject.*.*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion" -and ($_.message -match "TargetObject.*.*\\Windows\\Appinit_Dlls" -or $_.message -match "TargetObject.*.*\\Image File Execution Options" -or $_.message -match "TargetObject.*.*\\Drivers32"))) -or ((($_.ID -eq "12" -or $_.ID -eq "13" -or $_.ID -eq "14")) -and ($_.message -match "TargetObject.*.*\\Software\\Wow6432Node\\Microsoft\\Office" -or $_.message -match "TargetObject.*.*\\Software\\Microsoft\\Office") -and ($_.message -match "TargetObject.*.*\\Word\\Addins" -or $_.message -match "TargetObject.*.*\\PowerPoint\\Addins" -or $_.message -match "TargetObject.*.*\\Outlook\\Addins" -or $_.message -match "TargetObject.*.*\\Onenote\\Addins" -or $_.message -match "TargetObject.*.*\\Excel\\Addins" -or $_.message -match "TargetObject.*.*\\Access\\Addins" -or $_.message -match "TargetObject.*.*test\\Special\\Perf"))) -or ((($_.ID -eq "12" -or $_.ID -eq "13" -or $_.ID -eq "14")) -and ($_.message -match "TargetObject.*.*\\Software\\Wow6432Node\\Microsoft\\Internet Explorer" -or $_.message -match "TargetObject.*.*\\Software\\Microsoft\\Internet Explorer") -and ($_.message -match "TargetObject.*.*\\Toolbar" -or $_.message -match "TargetObject.*.*\\Extensions" -or $_.message -match "TargetObject.*.*\\Explorer Bars"))) -or ($_.message -match "TargetObject.*.*\\Software\\Wow6432Node\\Classes" -and ($_.message -match "TargetObject.*.*\\Folder\\ShellEx\\ExtShellFolderViews" -or $_.message -match "TargetObject.*.*\\Folder\\ShellEx\\DragDropHandlers" -or $_.message -match "TargetObject.*.*\\Folder\\ShellEx\\ColumnHandlers" -or $_.message -match "TargetObject.*.*\\Directory\\Shellex\\DragDropHandlers" -or $_.message -match "TargetObject.*.*\\Directory\\Shellex\\CopyHookHandlers" -or $_.message -match "TargetObject.*.*\\CLSID\\{AC757296-3522-4E11-9862-C17BE5A1767E}\\Instance" -or $_.message -match "TargetObject.*.*\\CLSID\\{ABE3B9A4-257D-4B97-BD1A-294AF496222E}\\Instance" -or $_.message -match "TargetObject.*.*\\CLSID\\{7ED96837-96F0-4812-B211-F13C24117ED3}\\Instance" -or $_.message -match "TargetObject.*.*\\CLSID\\{083863F1-70DE-11d0-BD40-00A0C911CE86}\\Instance" -or $_.message -match "TargetObject.*.*\\AllFileSystemObjects\\ShellEx\\DragDropHandlers" -or $_.message -match "TargetObject.*.*\\ShellEx\\PropertySheetHandlers" -or $_.message -match "TargetObject.*.*\\ShellEx\\ContextMenuHandlers"))) -or ($_.message -match "TargetObject.*.*\\Software\\Classes" -and ($_.message -match "TargetObject.*.*\\Folder\\ShellEx\\ExtShellFolderViews" -or $_.message -match "TargetObject.*.*\\Folder\\ShellEx\\DragDropHandlers" -or $_.message -match "TargetObject.*.*\\Folder\\Shellex\\ColumnHandlers" -or $_.message -match "TargetObject.*.*\\Filter" -or $_.message -match "TargetObject.*.*\\Exefile\\Shell\\Open\\Command\\(Default)" -or $_.message -match "TargetObject.*.*\\Directory\\Shellex\\DragDropHandlers" -or $_.message -match "TargetObject.*.*\\Directory\\Shellex\\CopyHookHandlers" -or $_.message -match "TargetObject.*.*\\CLSID\\{AC757296-3522-4E11-9862-C17BE5A1767E}\\Instance" -or $_.message -match "TargetObject.*.*\\CLSID\\{ABE3B9A4-257D-4B97-BD1A-294AF496222E}\\Instance" -or $_.message -match "TargetObject.*.*\\CLSID\\{7ED96837-96F0-4812-B211-F13C24117ED3}\\Instance" -or $_.message -match "TargetObject.*.*\\CLSID\\{083863F1-70DE-11d0-BD40-00A0C911CE86}\\Instance" -or $_.message -match "TargetObject.*.*\\Classes\\AllFileSystemObjects\\ShellEx\\DragDropHandlers" -or $_.message -match "TargetObject.*.*\\.exe" -or $_.message -match "TargetObject.*.*\\.cmd" -or $_.message -match "TargetObject.*.*\\ShellEx\\PropertySheetHandlers" -or $_.message -match "TargetObject.*.*\\ShellEx\\ContextMenuHandlers"))) -or ($_.message -match "TargetObject.*.*\\Software\\Policies\\Microsoft\\Windows\\System\\Scripts" -and ($_.message -match "TargetObject.*.*\\Startup" -or $_.message -match "TargetObject.*.*\\Shutdown" -or $_.message -match "TargetObject.*.*\\Logon" -or $_.message -match "TargetObject.*.*\\Logoff"))) -or ($_.message -match "TargetObject.*.*\\System\\CurrentControlSet\\Services\\WinSock2\\Parameters" -and ($_.message -match "TargetObject.*.*\\Protocol_Catalog9\\Catalog_Entries" -or $_.message -match "TargetObject.*.*\\NameSpace_Catalog5\\Catalog_Entries"))) -or ($_.message -match "TargetObject.*.*\\SYSTEM\\CurrentControlSet\\Control" -and ($_.message -match "TargetObject.*.*\\Terminal Server\\WinStations\\RDP-Tcp\\InitialProgram" -or $_.message -match "TargetObject.*.*\\Terminal Server\\Wds\\rdpwd\\StartupPrograms" -or $_.message -match "TargetObject.*.*\\SecurityProviders\\SecurityProviders" -or $_.message -match "TargetObject.*.*\\SafeBoot\\AlternateShell" -or $_.message -match "TargetObject.*.*\\Print\\Providers" -or $_.message -match "TargetObject.*.*\\Print\\Monitors" -or $_.message -match "TargetObject.*.*\\NetworkProvider\\Order" -or $_.message -match "TargetObject.*.*\\Lsa\\Notification Packages" -or $_.message -match "TargetObject.*.*\\Lsa\\Authentication Packages" -or $_.message -match "TargetObject.*.*\\BootVerificationProgram\\ImagePath")))) } | select TimeCreated, Id, RecordId, ProcessId, MachineName, Message;
            if ($result -and $result.Count -ne 0) {
                Write-Output ""; 
                Write-Output "Detected! RuleName:$ruleName";
                Write-Output $detectedMessage;
                Write-Output $result;
                Write-Output ""; 
            }
        };
        . Search-DetectableEvents $args;
    };
    if (! $ruleStack[$ruleName]) {
        $ruleStack.Add($ruleName, $detectRule);
    }
    else {
        Write-Host "Rule Import Error"  -Foreground Yellow;
    }
}
